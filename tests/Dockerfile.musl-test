# Test backtrace functionality on musl libc
FROM alpine:latest

# Install build tools and libexecinfo
RUN apk add --no-cache \
    build-base \
    openssl-dev \
    curl \
    libexecinfo \
    libexecinfo-dev

# Copy source files
WORKDIR /test
COPY ../tls_noverify.c .
COPY tests/test_backtrace.c .
COPY tests/test_framework.h .
COPY tests/test_musl_backtrace.sh .

# Build the library
RUN cc -fPIC -O2 -Wall -shared -o libtlsnoverify.so tls_noverify.c -ldl && \
    strip --strip-unneeded libtlsnoverify.so

# Run the test
CMD ["./test_musl_backtrace.sh"]